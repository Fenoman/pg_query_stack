-- Тест 014: CTE и рекурсивные запросы
-- Этот тест проверяет корректность работы с Common Table Expressions
-- включая рекурсивные CTE и вложенные CTE
-- Рекурсивный CTE тест 1
WITH RECURSIVE fibonacci(n, fib_n, fib_n_plus_1) AS (
                                                        -- Базовый случай
                                                        SELECT
                                                            1,
                                                            0::bigint,
                                                            1::bigint
                                                        UNION ALL
                                                        -- Рекурсивный случай
                                                        SELECT
                                                            n + 1,
                                                            fib_n_plus_1,
                                                            fib_n + fib_n_plus_1
                                                        FROM fibonacci
                                                        WHERE n < 10
                                                    )
SELECT
    MAX(fib_n) AS max_fibonacci,
    (
        SELECT
            COUNT(*)
        FROM pg_query_stack(0)
    ) AS recursive_stack_entries
FROM fibonacci;
 max_fibonacci | recursive_stack_entries 
---------------+-------------------------
            34 |                       1
(1 row)

-- Рекурсивный CTE тест 2
WITH RECURSIVE fibonacci(n, fib_n, fib_n_plus_1) AS (
                                                        -- Базовый случай
                                                        SELECT
                                                            1,
                                                            0::bigint,
                                                            1::bigint
                                                        UNION ALL
                                                        -- Рекурсивный случай
                                                        SELECT
                                                            n + 1,
                                                            fib_n_plus_1,
                                                            fib_n + fib_n_plus_1
                                                        FROM fibonacci
                                                        WHERE n < 10
                                                    )
SELECT
    fib_n AS fibonacci,
    (
        SELECT
            COUNT(*)
        FROM pg_query_stack(0)
    ) AS recursive_stack_entries
FROM fibonacci;
 fibonacci | recursive_stack_entries 
-----------+-------------------------
         0 |                       1
         1 |                       1
         1 |                       1
         2 |                       1
         3 |                       1
         5 |                       1
         8 |                       1
        13 |                       1
        21 |                       1
        34 |                       1
(10 rows)

-- Рекурсивный CTE тест 3
WITH RECURSIVE fibonacci(n, fib_n, fib_n_plus_1) AS (
                                                        -- Базовый случай
                                                        SELECT
                                                            1,
                                                            0::bigint,
                                                            1::bigint,
                                                            T.*
                                                        FROM pg_query_stack(0) AS T
                                                        UNION ALL
                                                        -- Рекурсивный случай
                                                        SELECT
                                                            n + 1,
                                                            fib_n_plus_1,
                                                            fib_n + fib_n_plus_1,
                                                            T.*
                                                        FROM fibonacci, pg_query_stack(0) AS T
                                                        WHERE n < 10
                                                    )
SELECT
    *
FROM fibonacci;
 n  | fib_n | fib_n_plus_1 | frame_number |                                           query_text                                           
----+-------+--------------+--------------+------------------------------------------------------------------------------------------------
  1 |     0 |            1 |            0 | WITH RECURSIVE fibonacci(n, fib_n, fib_n_plus_1) AS (                                         +
    |       |              |              |                                                         -- Базовый случай                     +
    |       |              |              |                                                         SELECT                                +
    |       |              |              |                                                             1,                                +
    |       |              |              |                                                             0::bigint,                        +
    |       |              |              |                                                             1::bigint,                        +
    |       |              |              |                                                             T.*                               +
    |       |              |              |                                                         FROM pg_query_stack(0) AS T           +
    |       |              |              |                                                         UNION ALL                             +
    |       |              |              |                                                         -- Рекурсивный случай                 +
    |       |              |              |                                                         SELECT                                +
    |       |              |              |                                                             n + 1,                            +
    |       |              |              |                                                             fib_n_plus_1,                     +
    |       |              |              |                                                             fib_n + fib_n_plus_1,             +
    |       |              |              |                                                             T.*                               +
    |       |              |              |                                                         FROM fibonacci, pg_query_stack(0) AS T+
    |       |              |              |                                                         WHERE n < 10                          +
    |       |              |              |                                                     )                                         +
    |       |              |              | SELECT                                                                                        +
    |       |              |              |     *                                                                                         +
    |       |              |              | FROM fibonacci;
  2 |     1 |            1 |            0 | WITH RECURSIVE fibonacci(n, fib_n, fib_n_plus_1) AS (                                         +
    |       |              |              |                                                         -- Базовый случай                     +
    |       |              |              |                                                         SELECT                                +
    |       |              |              |                                                             1,                                +
    |       |              |              |                                                             0::bigint,                        +
    |       |              |              |                                                             1::bigint,                        +
    |       |              |              |                                                             T.*                               +
    |       |              |              |                                                         FROM pg_query_stack(0) AS T           +
    |       |              |              |                                                         UNION ALL                             +
    |       |              |              |                                                         -- Рекурсивный случай                 +
    |       |              |              |                                                         SELECT                                +
    |       |              |              |                                                             n + 1,                            +
    |       |              |              |                                                             fib_n_plus_1,                     +
    |       |              |              |                                                             fib_n + fib_n_plus_1,             +
    |       |              |              |                                                             T.*                               +
    |       |              |              |                                                         FROM fibonacci, pg_query_stack(0) AS T+
    |       |              |              |                                                         WHERE n < 10                          +
    |       |              |              |                                                     )                                         +
    |       |              |              | SELECT                                                                                        +
    |       |              |              |     *                                                                                         +
    |       |              |              | FROM fibonacci;
  3 |     1 |            2 |            0 | WITH RECURSIVE fibonacci(n, fib_n, fib_n_plus_1) AS (                                         +
    |       |              |              |                                                         -- Базовый случай                     +
    |       |              |              |                                                         SELECT                                +
    |       |              |              |                                                             1,                                +
    |       |              |              |                                                             0::bigint,                        +
    |       |              |              |                                                             1::bigint,                        +
    |       |              |              |                                                             T.*                               +
    |       |              |              |                                                         FROM pg_query_stack(0) AS T           +
    |       |              |              |                                                         UNION ALL                             +
    |       |              |              |                                                         -- Рекурсивный случай                 +
    |       |              |              |                                                         SELECT                                +
    |       |              |              |                                                             n + 1,                            +
    |       |              |              |                                                             fib_n_plus_1,                     +
    |       |              |              |                                                             fib_n + fib_n_plus_1,             +
    |       |              |              |                                                             T.*                               +
    |       |              |              |                                                         FROM fibonacci, pg_query_stack(0) AS T+
    |       |              |              |                                                         WHERE n < 10                          +
    |       |              |              |                                                     )                                         +
    |       |              |              | SELECT                                                                                        +
    |       |              |              |     *                                                                                         +
    |       |              |              | FROM fibonacci;
  4 |     2 |            3 |            0 | WITH RECURSIVE fibonacci(n, fib_n, fib_n_plus_1) AS (                                         +
    |       |              |              |                                                         -- Базовый случай                     +
    |       |              |              |                                                         SELECT                                +
    |       |              |              |                                                             1,                                +
    |       |              |              |                                                             0::bigint,                        +
    |       |              |              |                                                             1::bigint,                        +
    |       |              |              |                                                             T.*                               +
    |       |              |              |                                                         FROM pg_query_stack(0) AS T           +
    |       |              |              |                                                         UNION ALL                             +
    |       |              |              |                                                         -- Рекурсивный случай                 +
    |       |              |              |                                                         SELECT                                +
    |       |              |              |                                                             n + 1,                            +
    |       |              |              |                                                             fib_n_plus_1,                     +
    |       |              |              |                                                             fib_n + fib_n_plus_1,             +
    |       |              |              |                                                             T.*                               +
    |       |              |              |                                                         FROM fibonacci, pg_query_stack(0) AS T+
    |       |              |              |                                                         WHERE n < 10                          +
    |       |              |              |                                                     )                                         +
    |       |              |              | SELECT                                                                                        +
    |       |              |              |     *                                                                                         +
    |       |              |              | FROM fibonacci;
  5 |     3 |            5 |            0 | WITH RECURSIVE fibonacci(n, fib_n, fib_n_plus_1) AS (                                         +
    |       |              |              |                                                         -- Базовый случай                     +
    |       |              |              |                                                         SELECT                                +
    |       |              |              |                                                             1,                                +
    |       |              |              |                                                             0::bigint,                        +
    |       |              |              |                                                             1::bigint,                        +
    |       |              |              |                                                             T.*                               +
    |       |              |              |                                                         FROM pg_query_stack(0) AS T           +
    |       |              |              |                                                         UNION ALL                             +
    |       |              |              |                                                         -- Рекурсивный случай                 +
    |       |              |              |                                                         SELECT                                +
    |       |              |              |                                                             n + 1,                            +
    |       |              |              |                                                             fib_n_plus_1,                     +
    |       |              |              |                                                             fib_n + fib_n_plus_1,             +
    |       |              |              |                                                             T.*                               +
    |       |              |              |                                                         FROM fibonacci, pg_query_stack(0) AS T+
    |       |              |              |                                                         WHERE n < 10                          +
    |       |              |              |                                                     )                                         +
    |       |              |              | SELECT                                                                                        +
    |       |              |              |     *                                                                                         +
    |       |              |              | FROM fibonacci;
  6 |     5 |            8 |            0 | WITH RECURSIVE fibonacci(n, fib_n, fib_n_plus_1) AS (                                         +
    |       |              |              |                                                         -- Базовый случай                     +
    |       |              |              |                                                         SELECT                                +
    |       |              |              |                                                             1,                                +
    |       |              |              |                                                             0::bigint,                        +
    |       |              |              |                                                             1::bigint,                        +
    |       |              |              |                                                             T.*                               +
    |       |              |              |                                                         FROM pg_query_stack(0) AS T           +
    |       |              |              |                                                         UNION ALL                             +
    |       |              |              |                                                         -- Рекурсивный случай                 +
    |       |              |              |                                                         SELECT                                +
    |       |              |              |                                                             n + 1,                            +
    |       |              |              |                                                             fib_n_plus_1,                     +
    |       |              |              |                                                             fib_n + fib_n_plus_1,             +
    |       |              |              |                                                             T.*                               +
    |       |              |              |                                                         FROM fibonacci, pg_query_stack(0) AS T+
    |       |              |              |                                                         WHERE n < 10                          +
    |       |              |              |                                                     )                                         +
    |       |              |              | SELECT                                                                                        +
    |       |              |              |     *                                                                                         +
    |       |              |              | FROM fibonacci;
  7 |     8 |           13 |            0 | WITH RECURSIVE fibonacci(n, fib_n, fib_n_plus_1) AS (                                         +
    |       |              |              |                                                         -- Базовый случай                     +
    |       |              |              |                                                         SELECT                                +
    |       |              |              |                                                             1,                                +
    |       |              |              |                                                             0::bigint,                        +
    |       |              |              |                                                             1::bigint,                        +
    |       |              |              |                                                             T.*                               +
    |       |              |              |                                                         FROM pg_query_stack(0) AS T           +
    |       |              |              |                                                         UNION ALL                             +
    |       |              |              |                                                         -- Рекурсивный случай                 +
    |       |              |              |                                                         SELECT                                +
    |       |              |              |                                                             n + 1,                            +
    |       |              |              |                                                             fib_n_plus_1,                     +
    |       |              |              |                                                             fib_n + fib_n_plus_1,             +
    |       |              |              |                                                             T.*                               +
    |       |              |              |                                                         FROM fibonacci, pg_query_stack(0) AS T+
    |       |              |              |                                                         WHERE n < 10                          +
    |       |              |              |                                                     )                                         +
    |       |              |              | SELECT                                                                                        +
    |       |              |              |     *                                                                                         +
    |       |              |              | FROM fibonacci;
  8 |    13 |           21 |            0 | WITH RECURSIVE fibonacci(n, fib_n, fib_n_plus_1) AS (                                         +
    |       |              |              |                                                         -- Базовый случай                     +
    |       |              |              |                                                         SELECT                                +
    |       |              |              |                                                             1,                                +
    |       |              |              |                                                             0::bigint,                        +
    |       |              |              |                                                             1::bigint,                        +
    |       |              |              |                                                             T.*                               +
    |       |              |              |                                                         FROM pg_query_stack(0) AS T           +
    |       |              |              |                                                         UNION ALL                             +
    |       |              |              |                                                         -- Рекурсивный случай                 +
    |       |              |              |                                                         SELECT                                +
    |       |              |              |                                                             n + 1,                            +
    |       |              |              |                                                             fib_n_plus_1,                     +
    |       |              |              |                                                             fib_n + fib_n_plus_1,             +
    |       |              |              |                                                             T.*                               +
    |       |              |              |                                                         FROM fibonacci, pg_query_stack(0) AS T+
    |       |              |              |                                                         WHERE n < 10                          +
    |       |              |              |                                                     )                                         +
    |       |              |              | SELECT                                                                                        +
    |       |              |              |     *                                                                                         +
    |       |              |              | FROM fibonacci;
  9 |    21 |           34 |            0 | WITH RECURSIVE fibonacci(n, fib_n, fib_n_plus_1) AS (                                         +
    |       |              |              |                                                         -- Базовый случай                     +
    |       |              |              |                                                         SELECT                                +
    |       |              |              |                                                             1,                                +
    |       |              |              |                                                             0::bigint,                        +
    |       |              |              |                                                             1::bigint,                        +
    |       |              |              |                                                             T.*                               +
    |       |              |              |                                                         FROM pg_query_stack(0) AS T           +
    |       |              |              |                                                         UNION ALL                             +
    |       |              |              |                                                         -- Рекурсивный случай                 +
    |       |              |              |                                                         SELECT                                +
    |       |              |              |                                                             n + 1,                            +
    |       |              |              |                                                             fib_n_plus_1,                     +
    |       |              |              |                                                             fib_n + fib_n_plus_1,             +
    |       |              |              |                                                             T.*                               +
    |       |              |              |                                                         FROM fibonacci, pg_query_stack(0) AS T+
    |       |              |              |                                                         WHERE n < 10                          +
    |       |              |              |                                                     )                                         +
    |       |              |              | SELECT                                                                                        +
    |       |              |              |     *                                                                                         +
    |       |              |              | FROM fibonacci;
 10 |    34 |           55 |            0 | WITH RECURSIVE fibonacci(n, fib_n, fib_n_plus_1) AS (                                         +
    |       |              |              |                                                         -- Базовый случай                     +
    |       |              |              |                                                         SELECT                                +
    |       |              |              |                                                             1,                                +
    |       |              |              |                                                             0::bigint,                        +
    |       |              |              |                                                             1::bigint,                        +
    |       |              |              |                                                             T.*                               +
    |       |              |              |                                                         FROM pg_query_stack(0) AS T           +
    |       |              |              |                                                         UNION ALL                             +
    |       |              |              |                                                         -- Рекурсивный случай                 +
    |       |              |              |                                                         SELECT                                +
    |       |              |              |                                                             n + 1,                            +
    |       |              |              |                                                             fib_n_plus_1,                     +
    |       |              |              |                                                             fib_n + fib_n_plus_1,             +
    |       |              |              |                                                             T.*                               +
    |       |              |              |                                                         FROM fibonacci, pg_query_stack(0) AS T+
    |       |              |              |                                                         WHERE n < 10                          +
    |       |              |              |                                                     )                                         +
    |       |              |              | SELECT                                                                                        +
    |       |              |              |     *                                                                                         +
    |       |              |              | FROM fibonacci;
(10 rows)

-- Вложенные CTE
CREATE OR REPLACE FUNCTION test_nested_cte ()
    RETURNS table
            (
                outer_value int,
                frame_number_in int,
                query_text_in text,
                frame_number int,
                query_text text
            )
    LANGUAGE plpgsql
AS
$$
BEGIN
    RETURN QUERY WITH outer_cte AS (
                                       SELECT
                                           GENERATE_SERIES(1, 3) AS outer_id
                                   ),
                      inner_cte AS (
                                       SELECT
                                           o.outer_id,
                                           T.*
                                       FROM outer_cte o, pg_query_stack(0) AS T
                                    )
                 SELECT
                     ic.outer_id::int,
                     ic.frame_number AS  frame_number_in,
                     ic.query_text AS query_text_in,
                     T.*
                 FROM inner_cte ic, pg_query_stack(0) AS T
                 LIMIT 1;
END;
$$;
SELECT
    *
FROM test_nested_cte();
 outer_value | frame_number_in |      query_text_in      | frame_number |       query_text        
-------------+-----------------+-------------------------+--------------+-------------------------
           1 |               0 | SELECT                 +|            0 | SELECT                 +
             |                 |     *                  +|              |     *                  +
             |                 | FROM test_nested_cte(); |              | FROM test_nested_cte();
(1 row)

-- Очистка
DROP FUNCTION test_nested_cte();
DISCARD ALL;
